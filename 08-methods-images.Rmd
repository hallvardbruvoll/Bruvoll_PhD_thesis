# Methods: Fractal image analysis {#images-methods}

In this chapter I present briefly the techniques for calculating fractal dimension and lacunarity estimates on archaeological and synthetic settlement plans, as applied further on. The chosen procedure for preparing images of these plans for analysis is also detailed. I review some issues related to the interpretation of these measurements, mainly in terms of visual pattern characteristics and textures. In order to evaluate how various parameters influence fractal dimension and lacunarity estimates on images, some tests on synthetically generated images are provided and discussed. Results of analyses on images of archaeological settlement plans are presented in the following chapter. #recheck this intro

## Calculating fractal dimension and lacunarity {#images-procedure}

As noted in the previous chapter, the fractal dimension of spatial patterns was originally estimated by Mandelbrot by deciphering visually the relations of size and frequency of elements between the *initiator* and the *generator* of theoretical (i.e. fully regular) fractal sets like the Koch curve or the Sierpinski triangle [e.g. @mandelbrot1982, p. 39 ff.]. Empirical fractals on the other hand usually also include some stochastic elements, rendering this technique much more difficult to use in practice, as the generator of the pattern is harder or even impossible to discern. A number of more systematic methods have therefore been developed since the 1980s for estimating the fractal dimension of empirical patterns, the by far most popular being the so-called box-counting method [@li2009; @klinkenberg1994]. The principle of the method is quite simple:

-   Cover the pattern with a regular square grid of a given mesh ("box") size, and count the number of boxes that intersect with the pattern.

-   Do this for a range of box sizes (usually in exponential steps from the pixel size up to about half of the image length), recording the number of boxes for each size.

-   Fit a linear model to the logarithms of box counts to box sizes, and the slope of the line corresponds to an approximation of the fractal dimension of the pattern.

Readers of Section \@ref(power-law) will recognise that the relationship between box sizes and box count is a power law with fractal dimension being defined as its scaling exponent, and while one may wonder why the log-log fitting method is accepted here when it was banned in previous chapters, there are some differences between the two contexts. Firstly, we are not dealing here with univariate distributions and their underlying generative mechanisms, but rather the relation between two variables. Secondly, the fractal dimension (in the following denoted *D*) is *defined* as this scaling exponent, that is the logarithm of frequency (number of elements) divided by the logarithm of their sizes relative to the whole (#did I remember to add an equation of D in chapter 7?). In theory, the graph of boxes to box sizes should always follow a power law -- i.e. a straight line on a log-log plot -- but with a fractional slope value when the pattern is fractal and an integer slope value when the pattern is a fully Euclidean shape.

There are some caveats regarding the interpretation of this estimate however. One is that there is nothing preventing a fractal shape of having an integer dimensional value. Its defining characteristic is that unlike Euclidean dimensions it can take on any value from 0 to 3 for spatial patterns and higher for more abstract patterns, and the numbers 0, 1, 2 and 3 are values just like any other in this continuous range. An integer dimension is thus in itself not enough to claim that a pattern is Euclidean and not fractal (though fractals with exactly integer dimensions are rare). But it is more important to consider what exactly is meant by Euclidean shapes in this context, namely a shape that entirely fills its embedding Euclidean dimension like a square or circle in two-dimensional space or a straight line segment in one dimension. An entirely regular grid pattern consisting only of identical squares or circles with some space between them does not fill its embedding space, and will have a fractional dimension when analysed through box counting, even though it can hardly be described as scale-invariant or fractal (examples are given below). For such cases, the total area of the pattern, approximated by the box count times box size, will be unstable down to the image resolution, as if the pattern were truly fractal. The dimension value obtained through box counting is thus in itself not a guarantee for the pattern being either Euclidean or fractal, which is why it is more accurate to refer to it as the *box-counting dimension* or *D~box~*. This has led to numerous confusions and erroneous interpretations in earlier studies involving box counting [e.g. @brown2003, @oleschko, see further discussion in \@ref(disc-methods)], and it illustrates the difficulty involved in interpreting the obtained values. This is also largely why I have opted for a more prudent empirical approach using synthetically constructed images to guide interpretation, testing for the effects of different variables one-by-one as presented below.

Some similar issues concern the estimation of lacunarity in empirical patterns. While Mandelbrot mainly relied on regular constructed fractals for estimating lacunarity, empirical patterns involving stochastic processes require more formal methods for analysis. The main method for estimating lacunarity is the so-called gliding-box method [@allain1991; @hingee2019; @cheng1997; @plotnick1996]. Similarly to box counting, it involves evaluating the pattern over a range of scales (box sizes), but in stead of a grid, a single box is glided incrementally across the image with overlaps (rendering the method computationally heavier). For each increment, the pixel mass (number of foreground or pattern pixels) within the window is recorded, and the average spread of this over all box displacements for a given box size is calculated, giving a lacunarity index (#refer to the equation in chapter 7). This index -- i.e. lacunarity for a given box size, is then plotted according to box size, and unlike the fractal (box-counting) dimension, the shape of the lacunarity curve can effectively give an indication of whether or not, or over which scales, the analysed pattern is fractal. For regularly self-similar mono-fractals, the curve of the lacunarity index forms a straight line in log-log scales, with the slope being equal to *D--E*, i.e. the fractal dimension of the pattern minus its Euclidean dimension [@plotnick1996, p. 5463; @allain1991; @mandelbrot1982, pp.315-7]. Since real-world patterns are rarely self-similar over very large ranges, and even less so for image renderings of them which depend on pixel resolution, this lacunarity index curve tends to follow a power law less strictly than that of box counts, even when the pattern is fractal-like over some scales.

Mandelbrot never gave any single definition of a summary statistic for lacunarity across scales like the fractal dimension, and several such summary measures have subsequently been proposed. The software plugin *FracLac* for *ImageJ* offers principally three of these, namely the exponent and prefactor values of a power-law approximation of the lacunarity index, as well as its arithmetic mean [@karperien2013]. There is little literature on the relationship between these, and it is not always clear which one of these is applied. Far√≠as-Pelayo seems to be using exponent lacunarity in [@farias-pelayo2017] and a mixture of this and mean lacunarity in [@farias-pelayo2015]. The value range of the power-law exponent should be expected to vary much less than that of the mean or prefactor, and these latter two cannot be below 1, while the exponent can in theory go down to 0 [a full pattern with no gaps and *D* = 2 for spatial patterns, see also @bruvollforthcoming for further discussion on this issue]. As mentioned above, the power-law exponent is directly correlated to *D* in the case of self-similar mono-fractal patterns.

For practical applications, @hingee2019 recently showed that the lacunarity index is mathematically equivalent to spatial covariance, which has the further advantage of being more tolerant to irregular image outlines as well as missing data. From this they proposed a series of estimators that they showed to give more reliable results than the standard lacunarity estimate, and implemented these in the *R* package *lacunaritycovariance*. While both irregular outlines and missing data are continuously relevant issues in archaeology, I did not pursue these possibilities further here, though I made use of the gbl()-function (gliding-box lacunarity) from this package, with its default "GBLcc.pickaH" estimator, for calculating the lacunarity index of images. Fractal dimension was in this thesis calculated in *R* using the fract2D()-function from the *fractD* package [@mancuso2021]. For both analyses, box sizes (widths) were set to the default values in *fractD*, namely 1, 2, 4, 8, 16, 32, 64, 128, 256 and 512 pixels.

The analysed images of empirical settlement plans were prepared in QGIS 3.20.1, from shape-files that were kindly shared by their creators on behalf of the research projects in which the spatial data was collected [@hale2020; @ohlrau2020; @muller-scheessel2020; \@ref(material)]. In order to focus the analysis on architectural features only, all other spatial features were removed, while house polygons were rendered with black fill and no stroke, and rasterised to a Boolean (black-and-white) image with 0.5 m pixel resolution, and cropped to the minimal extent of the corresponding vector layer (Figure \@ref(fig:08-image-prep)). Differences in image processing between the *lacunaritycovariance* and the *fractD* packages made it necessary to store the images in two versions in separate folders, in .jpeg format with greyscale rendering (0 for black and 255 for white) for fractal dimension and in .tiff format with binary values (1 for black and 0 for white) for lacunarity. This preparation process is obviously not ideal, and is due to the lack, for the time being, of implementation of these methods in a single coherent *R* package. This also makes the use of ready-made image analysis softwares like the above mentioned *FracLac* plugin even more convenient. However, the advantages of still performing the analysis in *R*, include the full transparency and adaptability of the method implementation, as well the increased possibility of combining the analysis with other methods. The analysed images are reproduced in the Appendix \@ref(append-archaeo), and are available in their original sizes and formats in the #online repository, along with the code for analysing them.

(ref:08-image-prep) The applied image preparation procedure. Raw geomagnetic images (left) were interpreted and redrawn as shape-files by GIS specialists for publication within their respective research projects (middle). For the analyses presented here, architectural features were selected and rendered as black-and-white images with minimal rectangular frame by author. Example from the Nebelivka settlement plan: left and centre images adapted from @chapman2018, ¬© D. Hale under the ADS Terms of Use

```{r 08-image-prep, fig.cap="(ref:08-image-prep)", fig.scap="Illustration of the plan image preparation procedure"}
include_graphics("Data/fig08_image_prep.pdf")
```

In the following, I attempt to address the difficulty of interpreting fractal dimension and lacunarity measures of spatial patterns by testing the methods on synthetically produced images, designed to isolate relevant variables one by one. The chosen variables are perceived to be of importance specifically in the present context where the images of interest represent architectural features on archaeological settlement plans. While this is not a sufficient analysis for effectively modelling the relative effects that any of these parameters may have on *D* and *L* measurements in any image, it allows for an intuitive illustration of the complexity involved in analysing spatial textures. The chosen image variables which are selected here for empirical testing are image size, element count, element size, image density, element size distribution, self-similarity/clustering and random noise. While the first three are important for assessing the requirements of the analysed images for the methods to function properly, the latter two are are of more direct interest for the hypothesis which is proposed in this part of the thesis, namely that fractal image analysis may allow for quantification of the degrees of hierarchy and conscious planning in a society evident through the layout of its settlement plans. The variables density and size distribution are important aspects of any settlement plan, but say little by themselves about the extent to which the layout is planned or not, and their influence on fractal dimension and lacunarity measurements can thus in this context be regarded more as side effects. As is shown below and further discussed in Chapter \@ref(disc-methods), while spatial clustering, element size distribution and noise do have effects on both fractal dimension and lacunarity measurements, in many practical settings these effects tend to be drowned by those induced by other variables like image size and density. The possibility remains that these methods may prove useful for comparisons of settlements of similar size and density only, or by defining more formal model by which undesired effects of other variables may be factored out. Here I suggest thresholds from which image size and resolution seem to give stable results, and I provide only some very simple models are tentatively constructed to factor out image density. While more formal and complete modelling for these purposes would be warranted for obtaining more fine-grained results, this goes beyond the scope of the present study.

For the following tests, all images were constructed in R as data tables with x and y coordinates for each element ("house"), rendered with the *ggplot2* package [@wickham2016]. More specifically, in each image houses were represented as a geom_tile() layer with black fill and given height and width, and the background was set to white, while the theme_void() function allowed for removing the axes and grids altogether. With this procedure it was possible to generate incremental changes in a single variable on otherwise identical images. However, as some of the variables are inherently connected, full separation was not always possible. Again, all the generated and analysed images are included in Appendix \@ref(append-synth), and the original files and code for generating them, are available in the #online repository.

## Effects from image size, element size and element count

To test the effect from image size on fractal dimension and lacunarity measures, it was necessary to proceed in three steps (Figure \@ref(fig:08-N-im)). A first series was created in which a single image was simply scaled up from 40^2^ to 420^2^ pixels in 20 steps. The smallest image thus represented four square houses of size 10\*10 pixels, which with 0.5 m per pixel length (the resolution used with the actual settlement plans in the next chapter) gives houses of 25 m^2^. Each house filled the lower left quarter of a 4 times larger square, so that image density was kept at 0.25. Density is defined here as fraction of pattern pixels to the whole number of pixels. For the largest version of this pattern, each house thus had a side length of 52,5 m, giving a total surface of ca. 2.756 m^2^ per house, which is far above comparable values for houses in prehistoric settlement plans. Since in reality house sizes do not increase linearly with settlement size, but are more constant, a second series was created where the image size was incremented the same way, but with a constant house size of 25 m^2^, so that in order to also keep image density constant, house count (*N*) was increased proportionally with image size. For this series, the largest image then had $N = 21^2 = 441$ houses, thus emulating settlements of different sizes but with similarly sized houses and densities between houses. In other words, different image sizes could not be made keeping both density, house count and house size constant. A third series of 20 images was made where image size was kept constant at 420^2^ pixels, but with the same range of house count from 4 to 441 as well as house sizes from 105^2^ to 10^2^ pixels, or 2.756 to 25 m^2^.

(ref:08-N-im) Effects from image size, element count and element size on fractal dimension and lacunarity. Density is fixed at 0.25 for all images. Number labels represent iteration within each series. Image size is variable in the upper and lower series, house size in the upper and the vertical series, and house count in the vertical and the lower series. The three corner images are identical for two series each. Images are selected here to prevent overlaps

```{r 08-N-im, fig.cap="(ref:08-N-im)", fig.scap="Effects from image size, count and resolution on fractal dimension (D) and lacunarity (L)"}
include_graphics("Results/fig08_N_im.pdf")
```

The resulting fractal dimension and lacunarity measures for all images in these three series are shown in Figures \@ref(fig:08-IS-HS) to \@ref(fig:08-N-HS). In all three cases -- increased image size and house size, increased image size and house count, and increased house count and decreased house size -- there are clear tendencies. In the two first series (upper and lower images in Figure \@ref(fig:08-N-im)), fractal dimension increases with image size, seemingly independently from the evolution in the pattern given that density remains constant. In the third case, when image size is kept constant (right side images in Figure \@ref(fig:08-N-im)), changes in fractal dimension are much smaller and less systematic, however lacunarity changes with some fluctuation. Regarding the two different summary measures of lacunarity -- mean *L* and exponent *L* (see above) -- though not identical, they respond in very similar ways to changes in all three image series. However, it is important to notice that the direction of change in lacunarity is opposite depending of the summary measure in the first and third series, while identical in the second. This difference is not easy to explain, and underlines the importance of reporting explicitly which lacunarity measure is being used. As seen on these plots, the exponent lacunarity typically has values below or around 1, while the mean lacunarity may have much higher values and cannot be below 1 -- an observation that can serve as a rule of thumb for decrypting results where the exact type of measurement used is not explicitly reported.

(ref:08-IS-HS) Different image sizes and house sizes, with *N* = 4 and density = 0.25. Resulting fractal dimension (*D*) and mean lacunarity (*L_mean*, plot a) and exponent lacunarity (plot b). Images are numbered by iteration

```{r 08-IS-HS, fig.cap="(ref:08-IS-HS)", fig.scap="D and L estimates, variable image size and house size (resolution)"}
load("Results/fig08_IS_HS.RData")
fig08_IS_HS
```

In the first two series, where image size is variable, it should furthermore be noted that the changes in *D* and *L* measures between iterations roughly slow down as image size increases, potentially indicating that they approach the "true" values of the given pattern, and that the measurements of the smallest images are only statistical artefacts. Another parameter which is related to image size is the range of box widths used when analysing the images, and further study could allow for more elaboration on the possible influence this could have on the resulting estimates. In any case, the range of dimension values from 0.96 to 1.66 is considerable given that these images are practically the same besides image size. The range of lacunarity in these series is more moderate compared to the results from other variables presented below. The step-wise decrease in lacunarity seen especially in the image series of increasing *N* with image size (Figure \@ref(fig:08-N-IS)), is a further indication that the choice of box widths relative to the resolution of the image has a marked influence on the results.

(ref:08-N-IS) Variable element count (*N*) and image size, with constant house length of 10 pixels and density at 0.25. Resulting fractal dimension (*D*) and mean lacunarity (*L_mean*, plot a) and exponent lacunarity (L, plot b). Images are numbered by iteration

```{r 08-N-IS, fig.cap="(ref:08-N-IS)", fig.scap="D and L estimates, variable image size and element count"}
load("Results/fig08_N_IS.RData")
fig08_N_IS
```

The series with fixed image size and changes in house count and house size also show some convergence in results at higher iterations, though with seemingly more random volatility (Figure \@ref(fig:08-N-HS)). This indicates that with a given image size, zooming in and out on the pattern has very little influence on the measured fractal dimension (as would be expected from the theory), as long as the pattern is spatially homogeneous. Lacunarity estimates on the other hand, become influenced when zooming in too much, though it quickly stabilises when more of the pattern is included by zooming out. Judging from the results of all three size related image series, there might be some lower threshold of image size and resolution beyond which the box-counting and gliding-box methods become inaccurate, and that the "real" values for this regular square grid pattern of 0.25 density are close to those in the lower right end of Figure \@ref(fig:08-N-im), namely $D \approx 1.64$ and $L\_mean\approx 2.0$. For image size, the results start to converge at iteration 12 or around 260\*260 pixels (Figure \@ref(fig:08-N-IS)), given the box size range and fitting method used here. Furthermore, the choice of a 0.5 m per pixel resolution used in this thesis was arbitrary but came from the acknowledgement that higher resolution would only induce a false sense of accuracy, while lower resolution could potentially lump together archaeological spatial data. In Figure \@ref(fig:08-N-HS), estimates begin to stabilise at iteration 7 for mean lacunarity and 5 for exponent lacunarity. Using the more conservative option of 7 (discarding the most inaccurate data), the length of a house is here covered by $420/8/2 \approx 26$ pixels, which, if this represents 5 metres gives a resolution of $\approx 0.19$ metres per pixel, which again is about 0.04 or 4% of the house length. In other words, the results presented here indicate that when single pixels represent 4% or less of the smallest features that are being analysed, lacunarity estimates become inaccurate, while fractal dimension estimates remain more unaffected, again given the box widths and fitting method applied here. This sets a tentative upper threshold to image resolution, while the lower threshold should be determined by what gives an acceptable spatial representation of the data. The 0.5 metres per pixel resolution applied in Chapter \@ref(images-results) lets one pixel represent 10% of a 5 metres long wall, thus being within the threshold. The other way around, 0.5 metres is 4% of 12.5 metres, which would be the maximum size of the smallest mapped feature before the resolution would be too high for the lacunarity estimates to be accurate. This threshold value should however at this point only be understood as a rule-of-thumb, as its precision is difficult to quantify any further here. The effect of image resolution on *D* and *L* estimates of images with other pattern layouts and densities also remains unknown. And again, in these analyses image resolution is only an issue since the analysed pattern is not strictly speaking scale-invariant. Rather it has a clear lower bound, leaving large open spaces in the image when zooming in too much. This is also the case with settlement plans, which, no matter the degree of clustering and self-similarity, will always have a lower bound set by the human scale, since houses can only be so small.

(ref:08-N-HS) Variable house count (*N*) and house size, with fixed image size of 420^2^ pixels and density at 0.25. Resulting fractal dimension (*D*) and mean lacunarity (*L_mean*, plot a) and exponent lacunarity (*L*, plot b). Images are numbered by iteration

```{r 08-N-HS, fig.cap="(ref:08-N-HS)", fig.scap="D and L estimates, variable element count and element size (resolution), fixed image size"}
load("Results/fig08_N_HS.RData")
fig08_N_HS
```

\FloatBarrier

## Effects from density and size distribution

While density and size distribution of elements are not directly connected to layout type and regularity, as different layouts may have varying degrees of both, they are nonetheless important aspects of settlement plans. Different chrono-cultural contexts give settlement plans of different densities, and this aspect was one of the main differences between the "Anatolian village" and "Balkan village" types of the early Neolithic as shown by @furholt2016. The density between houses may be highly reflective of the organisation of village life as a whole, as well as of differences between areas of larger settlements. The importance of size distribution of houses for understanding the underlying social system and potential hierarchy between houses was shown in the previous chapters of this thesis.

For both of these variables, a series of 20 images was constructed with internal incremental change between images, keeping other variables constant. In order to avoid the issues related to image size and resolution presented above, image size was set here to 540\*540 pixels, with a regular grid of $N = 27^2 = 729$ houses (i.e. corresponding to rather large settlements from an archaeological point of view). Over the 20 images, density was set to vary incrementally from 0.05 (one pixel per house) to the upper limit where all houses percolate into a single filled square (density = 1, Figure \@ref(fig:08-dens-im)). Fractal dimension and lacunarity estimates of the images with variable density followed clear and regular trends, with *D* and *L* being seemingly exponentially correlated to density, as seen in how the step lengths between iteration points in Figure \@ref(fig:08-dens)b decrease at a constant rate. *L_mean* being already exponentially correlated to *D* (see further discussion below), it seems to follow a power-law relationship to density, meaning that low densities get very high values of *L_mean* and inversely. As should be expected the range in *D* values in this series is very wide, from approximately 1.0 (the dimension of a straight line segment with no surface) to above 1.8. In theory the single black box of which the last iteration image consists should have a dimension of 2, illustrating the limits of the box-counting method. This wide range also shows clearly that a fractional dimension value obtained from an image through box counting does not in itself mean that the analysed pattern is actually fractal (i.e. exhibiting self-similarity at a range of different scales). The observed lacunarity values of the last image of this series (no space between points) were, however, arbitrarily close to the theoretical values of 0 for *L* and 1 for *L_mean*.

(ref:08-dens-im) Fractal dimension and mean lacunarity of images with identical size and layout, but with densities varying with linear increments from 0.05 to 1. Number labels represent iteration, and images are selected to prevent overlaps

```{r 08-dens-im, fig.cap="(ref:08-dens-im)", fig.scap="Effect of pixel density on D and L"}
include_graphics("Results/fig08_dens_im.pdf")
```

The exponential relationship between fractal dimension and density of spatial patterns was noted by @thomas2007, who -- based on the layouts of different suburbs of modern Brussels -- argued that *D* gave additional information on texture and clustering that density could not give. The constant relationship between *D* and density here shows that the two measures are largely equivalent, *given a constant layout*. To further investigate whether *D* and *L* measurements actually capture anything more than density, in the remaining image series density was kept constant at 0.25.

(ref:08-dens) Fractal dimension and lacunarity measures on the same 20 images with varying density. Because of pixelation the first image was rounded up to be identical to the second, with density = 0.01. Number labels represent iterations

```{r 08-dens, fig.cap="(ref:08-dens)", fig.scap="D and L estimates, variable pixel density"}
load("Results/fig08_dens.RData")
fig08_dens
```

A natural follow-up from the preceding chapters is to test to which extent different size distributions of houses are reflected in fractal dimension and lacunarity of settlement plans, all other things being equal. A series of 20 images were generated with gradually increased inequality between house sizes, with image size kept at 540^2^ pixels and N = 729 (27 rows and columns in a square grid). The size distribution was defined as a log-normal with an arbitrary mean at $\mu = 3.5$ and standard deviations varying in linear increments between $0 < \sigma < 0.9$. The first image was thus uniform with identical house sizes, while the last image had some sizes that were much larger than most of the others. For each image, the size distribution was normalised to 1 and multiplied with the desired fraction of the total image area so that density was kept at 0.25 (with small deviations due to occasional overlaps between neighbouring houses). This series thus illustrates settlements of identical size and layout, but where the size distribution of houses range from (nearly) identical to very unequal (Figure \@ref(fig:08-distr-im)).

(ref:08-distr-im) Fractal dimension and mean lacunarity of images with identical size, layout and density but with varying size distributions of single elements, from uniform (image 1) to log-normal with $\sigma = 0.9$ (image 20), in linear increments of $\sigma$ from 0. Number labels represent iteration, and images are selected here to prevent overlaps

```{r 08-distr-im, fig.cap="(ref:08-distr-im)", fig.scap="Effect of size distribution of elements on D and L"}
include_graphics("Results/fig08_distr_im.pdf")
```

The fractal dimension of the images with variable house-size distributions dropped from the value of the first iteration ($D \approx 1.56$) to around 1.52 where it fluctuated with no clear pattern for the remaining iterations (Figure \@ref(fig:08-distr)). Lacunarity -- both the mean and exponent summary measures -- increased gradually for almost every iteration, showing how this measure quantifies the increasing irregularity of the gaps between elements, and not only the sum of the gap sizes (i.e. density). Though this trend seems clear enough, the range of lacunarity values on this series remains moderate compared to those obtained from the series with variable density.

(ref:08-distr) Fractal dimension and lacunarity estimates of the whole image series, with 729 square points varying in size distribution from uniform (log-normal with $\sigma = 0$) to log-normal with $\sigma = 0.9$. For each image, sizes were normalised so that they together covered 25% of the total image area, notwithstanding some overlaps causing image density to descend to a minimum of 0.242. Label numbers indicate iteration

```{r 08-distr, fig.cap="(ref:08-distr)", fig.scap="D and L estimates, variable size distribution of elements"}
load("Results/fig08_distr.RData")
fig08_distr
```

\FloatBarrier

## Quantification of self-similarity and random noise

To assess the effect of spatial self-similarity or hierarchical clustering, an image series was generated where, as before, image size, N and density were kept constant, and the size distribution was kept uniform, but where the spaces between houses were gradually increased or reduced so that houses increasingly would form hierarchical clusters. This can be done in a number of ways -- in this case two levels of clusters were generated (a third being the settlement as a whole), the lower consisting of 3\*3 houses and the upper of 3\*3 lower clusters (Figure \@ref(fig:08-clustering-im)). This configuration was the reason for choosing 27 rows and columns in the first place for all these image series, since it can conveniently allow for such hierarchical clustering without having non-integer numbers of houses (or houses of different sizes). The first image in this series was thus an entirely regular grid identical to the first image in the size distribution series described above, but the last image here represents a rather different layout, illustrating settlements where hierarchical organisational levels result in self-similar clustering of the overall plan, as described by Brown and Witschey for classical and post-classical Maya urban settlements [-@brown2003, pp. 1625-8]. As they argue, the underlying hierarchical levels of social organisation (e.g. family, lineage, clan, state) have been widely observed and described by ethnographers and historians, while the materialisation of such hierarchies in settlement plans is far more rarely recognised, and even less so in terms of fractal geometry.

(ref:08-clustering-im) Fractal dimension and mean lacunarity of images of identical size, layout and density, but with degrees of hierarchical clustering, from no clustering (image 1) to high clustering in two levels, where the space between clusters represent 8% of the superior level's total length and the points start to percolate (image 20). Number labels represent iteration, and images are selected to prevent overlaps

```{r 08-clustering-im, fig.cap="(ref:08-clustering-im)", fig.scap="Effect of hierarchical clustering on D and L"}
include_graphics("Results/fig08_clustering_im.pdf")
```

The resulting fractal dimension and lacunarity estimates on these images show a very similar trend as the one observed on the size distributions image series (Figure \@ref(fig:08-clustering)). However, in this case *D* continues to drop from the first until the last iteration, albeit with some seemingly random fluctuations. Furthermore, after the first five iterations (which are in reality quite close to the entirely regular grid, see Figure \@ref(fig:08-clustering-im)), both lacunarity measures given here start to increase and do so regularly until the end of the series. Though again the ranges in both dimension and lacunarity are rather moderate here compared to those seen for density and image size above, the trend seen here is clear enough to conclude that hierarchical clustering is reflected in both these measures, in good accordance with the theory.

(ref:08-clustering) Fractal dimension and lacunarity measures on the same images with varying degrees of spatial clustering, and fixed image size, density, element count and size distributions. Number labels represent iteration

```{r 08-clustering, fig.cap="(ref:08-clustering)", fig.scap="D and L estimates, variable degrees of clustering"}
load("Results/fig08_clustering.RData")
fig08_clustering
```

As a last test series of images to facilitate interpretation of fractal dimension and lacunarity estimates of settlement plans, 20 images were generated from the same point of departure as before -- i.e. image size of 540\*540 pixels, 27\*27 houses each of 10\*10 pixel size, giving 0.25 image density -- but where an increasing amount of spatial noise was added for each iteration. Again, this could be done in a number of ways. In this case, each house was allowed to do an independent random walk with a step length of 2.4 pixel equivalents in one out of 12 circular directions (this caused some greyscaling in the resulting images, but the applied box-counting and gliding-box functions round such values to 0 and 1). Each random-walk step represented one iteration in the series [see @bruvollforthcoming for a similar approach]. An advantage of using square synthetic images for this test rather than simulations of actual settlement plans, is that the effect from such spatial noise can be more easily isolated from density. When elements walk in random directions, some will inevitably walk out and away from the initial pattern, thus decreasing image density no wether the image is extended to include them or not. To solve this issue and making sure that density remained as constant as possible given how it was shown above to influence the resulting estimates, the image size was here kept constant and houses that walked beyond the boundaries were moved across the image to the opposite side. Some decrease in image density was however difficult to avoid given the frequent overlaps of the areas of houses that walked very close to each other. As a result, the lowest density in this series extended to 0.232, which is still fairly close to the goal of 0.25. The resulting more or less noisy images in this series thus illustrate the range of possible settlement layouts from one where every house is strictly allotted to a predefined place following a simple geometric grid, to one where houses are constructed completely without any regard to the placement of surrounding houses (Figure \@ref(fig:08-noise-im)). Neither of these extremes are of course very likely for any real archaeological setting, but it seems obvious that the former case will be more characteristic of societies with strong overarching institutions that regulate everyday life while the latter case is more representative of very loose social ties between independent households and an absence of any overarching decision-making authority. #Ref?

(ref:08-noise-im) Fractal dimension and mean lacunarity of images of identical size, layout and density, with varying degrees of added spatial noise, generated by letting each house independently perform a random walk of constant step length in random directions, from no steps (image 1) to 19 steps (image 20). Number labels represent iteration, and images are selected to prevent overlaps

```{r 08-noise-im, fig.cap="(ref:08-noise-im)", fig.scap="Effect of random noise on D and L"}
include_graphics("Results/fig08_noise_im.pdf")
```

The resulting *D* and *L* measures from these images follow the same general trajectory as the images with variable clustering and size distribution, with lower fractal dimension and higher lacunarity for each step of added noise (Figure \@ref(fig:08-noise)). The fractal dimension estimates oscillate in a few cases, possibly because of sudden random correspondence between the initial pattern grid and the box sizes used in the calculations. The lacunarity estimates -- both the mean and the exponent lacunarity -- followed very regular increase after the second iteration. Here again, the trend seems sufficiently regular to conclude that random noise is effectively quantified by both fractal dimension and lacunarity, in a similar way to the other changes in pattern presented above.

(ref:08-noise) Estimates of fractal dimension (*D*) and mean lacunarity (plot a) and exponent lacunarity (plot b), of 20 images with increasing degrees of added random spatial noise. Number labels represent iteration

```{r 08-noise, fig.cap="(ref:08-noise)", fig.scap="D and L estimates with variable degrees of added random noise"}
load("Results/fig08_noise.RData")
fig08_noise
```

\FloatBarrier

## Summary of procedure and tests

Calculations of fractal dimension and lacunarity on synthetically generated test images provide useful clarifications on how these measures respond to changes in some crucial variables. The tests on image series with varying image sizes and zooms on a regular square grid pattern indicate that both *D* and *L* measures become increasingly inaccurate when estimated on images smaller than about 260\*260 pixels, given the box sizes used here in the analyses. The values were calculated from bi-logarithmic linear fits to results for box sizes ranging from 1 to 512 pixel lengths, where null values were excluded from the fit whenever the analysed images were smaller than the box size. Reducing the maximum box sizes remains a possibility that could allow for more accurate estimates from small images, which again could prove useful whenever run time becomes an issue, since larger images are computationally much heavier to analyse. With the test images analysed here, too small images gave too low fractal dimension estimates, while lacunarity was seemingly less affected (Figure \@ref(fig:08-N-im)).

Another requirement for reaching acceptable accuracy in fractal dimension and lacunarity results, is that the image resolution should seemingly not exceed pixel sizes smaller than about 4% of the side length of the smallest mapped features. Letting pixels be smaller than this (i.e. *higher* image resolution) only adds a false sense of accuracy given that the analysed patterns are not strictly speaking scale independent but rather bound to the scales that are relevant for human agency. A too high resolution thus generates too large void spaces between elements, leading to too high lacunarity values, while fractal dimension in this case remains less affected.

Other variables, which were more related to the visual appearance of the pattern, also gave characteristic results. Size distribution of pattern elements, level of hierarchical clustering and random spatial noise all affected *D* and *L* measures in a similar way, in that larger deviations from homogeneity drew the former values down and the latter up in a consistent way. Density on the other hand, had a different effect on *D* and *L* estimates in two ways. Firstly, increased image density gave consistently *higher* fractal dimension and *lower* lacunarity values, and secondly -- though the intensity of the different variables are difficult to compare -- the effect from density appeared here as much stronger than that of the others. Figures \@ref(fig:08-all-im) and \@ref(fig:08-all) illustrate how a minor adjustment in image density made more difference in both fractal dimension and lacunarity than the whole range of variation in noise, clustering and size distribution. One caveat here though, is that these variables are often in practice combined in empirical settlement plans -- there is usually both some level of clustering, noise and inequality in sizes -- and it remains unknown whether these factors combined give stronger signals compared to that of density. In any case, it seems clear that image density must be taken into consideration when interpreting the layout of settlement plans from their fractal dimension and/or lacunarity.

(ref:08-all-im) The first and last images of the clustering, size distribution and noise series, as well as images 8, 10 and 12 of the density series, showing how only small increments in density -- here from 0.16 (im. 8) to 0.36 (im. 12) -- generate changes in fractal dimension and lacunarity that are larger than those induced by the whole range of the other variables. Density image 10 is identical to image 1 of the three other series, and has density value 0.25

```{r 08-all-im, fig.cap="(ref:08-all-im)", fig.scap="Effect on D and L from density, compared to effects from size distribution, clustering and noise"}
include_graphics("Results/fig08_all_im.pdf")
```

From the results presented above, another trait seemed characteristic of the link between density, fractal dimension and lacunarity. All other things being equal, density was exponentially correlated to both *D* and *L*, and power-law correlated to *L_mean* (Figure \@ref(fig:08-dens)). In fact, for a regular square grid pattern with given density, these fractal analysis measures can seemingly be very well predicted with simple linear models on log-transformed density (Table \@ref(tab:08-models-tab)). These models can be used tentatively to compare *D* and *L* values of images with varying density, by first subtracting the values expected from density alone. However, it must again be stressed such an analysis probably is premature at this stage, since several factors remain unaccounted for. For example, regarding the Neolithic settlement plans compared in the next chapter, the effects on *D* and *L* from *different* settlement layouts remain untested (the standard Trypillia layout is radial and not a grid). Also, effects from size distribution, clustering and noise have only been evaluated here at a single given density value, and these may behave very differently at other density levels. As mentioned, these factors are usually mixed to some extent and may have non-linear effects that for now remain unknown. In empirical settings grid orientation and edge effects quickly become issues of their own that are also not further investigated here.

(ref:08-models-tab) Linear models of fractal dimension (*D*), exponent lacunarity (*L*) and mean lacunarity (*L_mean*) with the log-transformations that give the best fit, evaluated by the coefficient of determination ($R^2$). The third model can be written in power-law form as $L_{mean} = 0.862*density^{-0.61}$

```{r 08-models-tab}
load("Results/tab08_models.RData")
kable(tab08_models, booktabs = TRUE, caption = "(ref:08-models-tab)", caption.short = "Models of fractal dimension and lacunarity values expected from density") %>% 
  kable_styling(latex_options = c("striped", "scale down"))
```

(ref:08-all) Fractal dimension and lacunarity estimates of all synthetic images analysed in this chapter. *L_mean* and *L* show largely similar distributions but with some marked differences. See text for details. The grey frame in plot a shows the extent of Figure \@ref(fig:08-all-im)

```{r 08-all, fig.cap="(ref:08-all)", fig.scap="D and L estimates of all synthetic images"}
load("Results/fig08_all.RData")
fig08_all
```

Lastly, in this chapter I have largely opted for presenting results for both exponent lacunarity (here denoted simply *L*) and mean lacunarity (*L_mean*), since both are found in the literature as summary measures of lacunarity, but not always with explicit mention of what they represent mathematically [as in @farias-pelayo2017; @farias-pelayo2015]. The results here show that they are largely equivalent, a part from the differing value ranges. For two image series -- varying image size and house size (Figure \@ref(fig:08-IS-HS)), and varying house size and house count (Figure \@ref(fig:08-N-HS)) -- the results followed similar but reverse trajectories, without any obvious reason. And for density, as mentioned, *L_mean* was power-law correlated while *L* was only exponentially correlated (Figure \@ref(fig:08-dens)). I have elsewhere shown how prefactor lacunarity is very closely correlated to mean lacunarity, arguing that these two are practically linearly equivalent [@bruvollforthcoming; see also @karperien2013]. While studies in various fields refrain from using summary measures of lacunarity at all, preferring to rather show the full distribution of lacunarity to box sizes [e.g. in ecology, see @hingee2019], my impression here is that any of these summary measures may be used, as long as it remains clear which one it is. This relative equivalence being demonstrated, and for ease of presentation, in the following chapter I will largely focus on mean lacunarity values, while exponent and prefactor lacunarity values are given in the full data table in #ref appendix.

In the following chapter, the same methods of analysis are applied to images of archaeological settlement plans, in series consisting of total settlement plans, single quarters/neighbourhoods and temporally coeval sub-samples. The goal is then primarily to investigate how they perform with real archaeological spatial data, and to which extent they quantify different spatial layouts and textures that can be interpreted in terms of social organisation.

END Chapter
