# Methods: Fractal image analysis {#images-methods}

fdasdf

## Calculating fractal dimension and lacunarity

-   Box-counting, lit. @mancuso2021, @li2009, @klinkenberg1994

-   Gliding-box algorithms, @allain1991, @hingee2019, @cheng1997, @plotnick1996

-   Caveats:

    -   Fractional box-counting dimension does not equal self-similarity in a simple way

    -   My summary *L* is not equal to the one used in *FracLac* and thus by @far√≠as-pelayo2017

-   Image preparation procedure

-   State range of box sizes used here! (The default of fractD: 1, 2, 4, 8, 16, 32, 64, 128, 256, 512 pixels)

In the following, I attempt to address the difficulty of interpreting fractal dimension and lacunarity measures of spatial patterns by testing the methods on synthetically produced images, designed to isolate relevant variables one by one. The chosen variables are perceived to be of importance specifically in the present context where the images of interest represent architectural features on archaeological settlement plans. While this is not a sufficient analysis for effectively modelling the relative effects that any of these parameters may have on *D* and *L* measurements in any image, it allows for an intuitive illustration of the complexity involved in analysing spatial textures. The chosen image variables which are selected here for empirical testing are image size, element count, element size, image density, element size distribution, self-similarity/clustering and random noise. While the first three are important for assessing the requirements of the analysed images for the methods to function properly, the latter two are are of more direct interest for the hypothesis which is proposed in this part of the thesis, namely that fractal image analysis may allow for quantification of the degrees of hierarchy and conscious planning in a society evident through the layout of its settlement plans. The variables density and size distribution are important aspects of any settlement plan, but say little by themselves about the extent to which the layout is planned or not, and their influence on fractal dimension and lacunarity measurements can thus in this context be regarded more as side effects. As is shown below and further discussed in Chapter \@ref(disc-methods), while spatial clustering and noise do have effects on both fractal dimension and lacunarity measurements #RECHECK THIS#, for most practical purposes these effects tend to be drowned by those induced by other variables like image size and density. The possibility remains that these methods may prove useful for comparisons of settlements of similar size and density only, or by defining a more formal model by which undesired effects of other variables may be factored out #CHECK WORDING HERE AS WELL#. Such modelling however goes beyond the scope of the present study.

For the following tests, all images were constructed in R as data tables with x and y coordinates for each element ("house"), rendered with the *ggplot2* package [@wickham2016]. More specifically, in each image houses were represented as a geom_tile() layer with black fill and given height and width, and the background was set to white, while the theme_void() function allowed for removing the axes and grids altogether. With this procedure it was possible to generate incremental changes in a single variable on otherwise identical images. However, as some of the variables are inherently connected, full separation was not always possible. All the generated and analysed images are included in #Make Appendix, and the original files, as well as the code for generating them, are available in the #online repository.

## Effects from image size, element size and element count

To test the effect from image size on fractal dimension and lacunarity measures, it was necessary to proceed in three steps (Figure \@ref(fig:08-N-im)). A first series was created in which a single image was simply scaled up from 40^2^ to 420^2^ pixels in 20 steps. The smallest image thus represented four square houses of size 10\*10 pixels, which with 0.5 m per pixel length (the resolution used with the actual settlement plans in the next chapter) gives houses of 25 m^2^. Each house filled the lower left quarter of a 4 times larger square, so that image density was kept at 0.25. Density is defined here as fraction of pattern pixels to the whole number of pixels. For the largest version of this pattern, each house thus had a side length of 52,5 m, giving a total surface of ca. 2.756 m^2^ per house, which is far above comparable values for houses in prehistoric settlement plans. Since in reality house sizes do not increase linearly with settlement size, but are more constant, a second series was created where the image size was incremented the same way, but with a constant house size of 25 m^2^, so that in order to also keep image density constant, house count (*N*) was increased proportionally with image size. For this series, the largest image then had $N = 21^2 = 441$ houses, thus emulating settlements of different sizes but with similarly sized houses and densities between houses. In other words, different image sizes could not be made keeping both density, house count and house size constant. A third series of 20 images was made where image size was kept constant at 420^2^ pixels, but with the same range of house count from 4 to 441 as well as house sizes from 105^2^ to 10^2^ pixels, or 2.756 to 25 m^2^.

![Effects from image size, element count and element size on fractal dimension and lacunarity. Density is fixed at 0.25 for all images. Number labels represent iteration within each series. Image size is variable in the upper and lower series, house size in the upper and the vertical series, and house count in the vertical and the lower series. The three corner images are identical for two series each. Images are selected here to prevent overlaps](Results/fig08_N_im.pdf){#fig:08-N-im}

The resulting fractal dimension and lacunarity measures for all images in these three series are shown in Figures \@ref(fig:08-IS-HS) to \@ref(fig:08-N-HS). In all three cases -- increased image size and house size, increased image size and house count, and increased house count and decreased house size -- there are clear tendencies. In the two first series (upper and lower images in Figure \@ref(fig:08-N-im)), fractal dimension increases with image size, seemingly independently from the evolution in the pattern given that density remains constant. In the third case, when image size is kept constant (right side images in Figure \@ref(fig:08-N-im)), changes in fractal dimension are much smaller and less systematic, however lacunarity changes with some fluctuation. Regarding the two different summary measures of lacunarity -- mean *L* and exponent *L* (see above) -- though not identical, they respond in very similar ways to changes in all three image series. However, it is important to notice that the direction of change in lacunarity is opposite depending of the summary measure in the first and third series, while identical in the second. This difference is not easy to explain, and underlines the importance of reporting explicitly which lacunarity measure is being used. As seen on these plots, the exponent lacunarity typically has values below or around 1, while the mean lacunarity may have much higher values and cannot be below 1 -- an observation that can serve as a rule of thumb for decrypting results where the exact type of measurement used is not explicitly reported.

(ref:08-IS-HS) Different image sizes and house sizes, with *N* = 4 and density = 0.25. Resulting fractal dimension (*D*) and mean lacunarity (*L_mean*, plot a) and exponent lacunarity (plot b). Images are numbered by iteration

```{r 08-IS-HS, fig.cap="(ref:08-IS-HS)"}
load("Results/fig08_IS_HS.RData")
fig08_IS_HS
```

In the first two series, where image size is variable, it should furthermore be noted that the changes in *D* and *L* measures between iterations roughly slow down as image size increases, potentially indicating that they approach the "true" values of the given pattern, and that the measurements of the smallest images are only statistical artefacts. Another parameter which is related to image size is the range of box widths used when analysing the images, and further study could allow for more elaboration on the possible influence this could have on the resulting estimates. In any case, the range of dimension values from 0.96 to 1.66 is considerable given that these images are practically the same besides image size. The range of lacunarity in these series is more moderate compared to the results from other variables presented below. The step-wise decrease in lacunarity seen especially in the image series of increasing *N* with image size (Figure \@ref(fig:08-N-IS)), is a further indication that the choice of box widths relative to the resolution of the image has a marked influence on the results.

(ref:08-N-IS) Variable element count (*N*) and image size, with constant house length of 10 pixels and density at 0.25. Resulting fractal dimension (*D*) and mean lacunarity (*L_mean*, plot a) and exponent lacunarity (L, plot b). Images are numbered by iteration

```{r 08-N-IS, fig.cap="(ref:08-N-IS)"}
load("Results/fig08_N_IS.RData")
fig08_N_IS
```

The series with fixed image size and changes in house count and house size also show some convergence in results at higher iterations, though with seemingly more random volatility (Figure \@ref(fig:08-N-HS)). This indicates that with a given image size, zooming in and out on the pattern has very little influence on the measured fractal dimension (as would be expected from the theory), as long as the pattern is spatially homogeneous. Lacunarity estimates on the other hand, become influenced when zooming in too much, though it quickly stabilises when more of the pattern is included by zooming out. Judging from the results of all three size related image series, there might be some lower threshold of image size and resolution beyond which the box-counting and gliding-box methods become inaccurate, and that the "real" values for this regular square grid pattern of 0.25 density are close to those in the lower right end of Figure \@ref(fig:08-N-im), namely $D \approx 1.64$ and $L\_mean\approx 2.0$. For image size, the results start to converge at iteration 12 or around 260\*260 pixels (Figure \@ref(fig:08-N-IS)), given the box size range and fitting method used here. Furthermore, the choice of a 0.5 m per pixel resolution used in this thesis was arbitrary but came from the acknowledgement that higher resolution would only induce a false sense of accuracy, while lower resolution could potentially lump together archaeological spatial data. In Figure \@ref(fig:08-N-HS), estimates begin to stabilise at iteration 7 for mean lacunarity and 5 for exponent lacunarity. Using the more conservative option of 7 (discarding the most inaccurate data), the length of a house is here covered by $420/8/2 \approx 26$ pixels, which, if this represents 5 metres gives a resolution of $\approx 0.19$ metres per pixel, which again is about 0.04 or 4% of the house length. In other words, the results presented here indicate that when single pixels represent 4% or less of the smallest features that are being analysed, lacunarity estimates become inaccurate, while fractal dimension estimates remain more unaffected, again given the box widths and fitting method applied here. This sets a tentative upper threshold to image resolution, while the lower threshold should be determined by what gives an acceptable spatial representation of the data. The 0.5 metres per pixel resolution applied in Chapter \@ref(images-results) lets one pixel represent 10% of a 5 metres long wall, thus being within the threshold. The other way around, 0.5 metres is 4% of 12.5 metres, which would be the maximum size of the smallest mapped feature before the resolution would be too high for the lacunarity estimates to be accurate. This threshold value should however at this point only be understood as a rule-of-thumb, as its precision is difficult to quantify any further here. The effect of image resolution on *D* and *L* estimates of images with other pattern layouts and densities also remains unknown. And again, in these analyses image resolution is only an issue since the analysed pattern is not strictly speaking scale-invariant. Rather it has a clear lower bound, leaving large open spaces in the image when zooming in too much. This is also the case with settlement plans, which, no matter the degree of clustering and self-similarity, will always have a lower bound set by the human scale, since houses can only be so small.

(ref:08-N-HS) Variable house count (*N*) and house size, with fixed image size of 420^2^ pixels and density at 0.25. Resulting fractal dimension (*D*) and mean lacunarity (*L_mean*, plot a) and exponent lacunarity (*L*, plot b). Images are numbered by iteration

```{r 08-N-HS, fig.cap="(ref:08-N-HS)"}
load("Results/fig08_N_HS.RData")
fig08_N_HS
```

\FloatBarrier

## Effects from density and size distribution

While density and size distribution of elements are not directly connected to layout type and regularity, as different layouts may have varying degrees of both, they are nonetheless important aspects of settlement plans. Different chrono-cultural contexts give settlement plans of different densities, and this aspect was one of the main differences between the "Anatolian village" and "Balkan village" types of the early Neolithic as shown by @furholt2016. The density between houses may be highly reflective of the organisation of village life as a whole, as well as of differences between areas of larger settlements. The importance of size distribution of houses for understanding the underlying social system and potential hierarchy between houses was shown in the previous chapters of this thesis.

For both of these variables, a series of 20 images was constructed with internal incremental change between images, keeping other variables constant. In order to avoid the issues related to image size and resolution presented above, image size was set here to 540\*540 pixels, with a regular grid of $N = 27^2 = 729$ houses (so rather large settlements from an archaeological point of view). Over the 20 images, density was set to vary incrementally from 0.01 (four pixels per house) to the upper limit where all houses percolate into a single filled square (density = 1, Figure \@ref(fig:08-dens-im)). Fractal dimension and lacunarity estimates of the images with variable density followed clear and regular trends, with *D* and *L* being seemingly exponentially correlated to density, as seen in how the step lengths between iteration points in Figure \@ref(fig:08-dens)b decrease at a constant rate. *L_mean* being already exponentially correlated to *D* (see further discussion below), it seems to follow a power-law relationship to density, meaning that low densities get very high values of *L_mean* and inversely. As should be expected the range in *D* values in this series is very wide, from approximately 1.0 (the dimension of a straight line segment with no surface) to above 1.8. In theory the single black box of which the last iteration image consists should have a dimension of 2, illustrating the limits of the box-counting method. This wide range also shows clearly that a fractional dimension value obtained from an image through box counting does not in itself mean that the analysed pattern is actually fractal (i.e. exhibiting self-similarity at a range of different scales). The observed lacunarity values of the last image of this series (no space between points) were, however, arbitrarily close to the theoretical values of 0 for *L* and 1 for *L_mean*.

![Different image densities](Results/fig08_dens_im.pdf){#fig:08-dens-im}

The exponential relationship between fractal dimension and density of spatial patterns was noted by @thomas2007, who -- based on the layouts of different suburbs of modern Brussels -- argued that *D* gave additional information on texture and clustering that density could not give. The constant relationship between *D* and density here shows that the two measures are largely equivalent, *given a constant layout*. To further investigate whether *D* and *L* measurements actually capture anything more than density, in the remaining image series density was kept constant at 0.25.

(ref:08-dens) Fractal dimension and lacunarity measures on the same 20 images with varying density. Number labels represent iterations

```{r 08-dens, fig.cap="(ref:08-dens)"}
load("Results/fig08_dens.RData")
fig08_dens
```

A natural follow-up from the preceding chapters is to test to which extent different size distributions of houses are reflected in fractal dimension and lacunarity of settlement plans, all other things being equal. A series of 20 images were generated with gradually increased inequality between house sizes, with image size kept at 540^2^ pixels and N = 729 (27 rows and columns in a square grid). The size distribution was defined as a log-normal with an arbitrary mean at $\mu = 3.5$ and standard deviations varying in linear increments between $0 < \sigma < 0.9$. The first image was thus uniform with identical house sizes, while the last image had some sizes that were much larger than most of the others. For each image, the size distribution was normalised to 1 and multiplied with the desired fraction of the total image area so that density was kept at 0.25 (with small deviations due to occasional overlaps between neighbouring houses). This series thus illustrates settlements of identical size and layout, but where the size distribution of houses range from (nearly) identical to very unequal (Figure \@ref(fig:08-distr-im)).

![Different size distributions](Results/fig08_distr_im.pdf){#fig:08-distr-im}

The fractal dimension of the images with variable house-size distributions dropped from the value of the first iteration ($D \approx 1.56$) to around 1.52 where it fluctuated with no clear pattern for the remaining iterations (Figure \@ref(fig:08-distr)). Lacunarity -- both the mean and exponent summary measures -- increased gradually for almost every iteration, showing how this measure quantifies the increasing irregularity of the gaps between elements, and not only the sum of the gap sizes (i.e. density). Though this trend seems clear enough, the range of lacunarity values on this series remains moderate compared to those obtained from the series with variable density.

(ref:08-distr) Fractal dimension and lacunarity estimates of the whole image series, with 729 square points varying in size distribution from uniform (log-normal with $\sigma = 0$) to log-normal with $\sigma = 0.9$. For each image, sizes were normalised so that they together covered 25% of the total image area, notwithstanding some overlaps causing image density to descend to a minimum of 0.242. Label numbers indicate iteration

```{r 08-distr, fig.cap="(ref:08-distr)"}
load("Results/fig08_distr.RData")
fig08_distr
```

\FloatBarrier

## Quantification of self-similarity and random noise

To assess the effect of spatial self-similarity or hierarchical clustering, an image series was generated where, as before, image size, N and density were kept constant, and the size distribution was kept uniform, but where the spaces between houses were gradually increased or reduced so that houses increasingly would form hierarchical clusters. This can be done in a number of ways -- in this case two levels of clusters were generated (a third being the settlement as a whole), the lower consisting of 3\*3 houses and the upper of 3\*3 lower clusters (Figure \@ref(fig:08-clustering-im)). This configuration was the reason for choosing 27 rows and columns in the first place for all these image series, since it can conveniently allow for such hierarchical clustering without having non-integer numbers of houses (or houses of different sizes). The first image in this series was thus an entirely regular grid identical to the first image in the size distribution series described above, but the last image here represents a rather different layout, illustrating settlements where hierarchical organisational levels result in self-similar clustering of the overall plan, as described by Brown and Witschey for classical and post-classical Maya urban settlements [-@brown2003, pp. 1625-8]. As they argue, the underlying hierarchical levels of social organisation (e.g. family, lineage, clan, state) have been widely observed and described by ethnographers and historians, while the materialisation of such hierarchies in settlement plans is far more rarely recognised, and even less so in terms of fractal geometry.

![Different degrees of clustering and self-similarity](Results/fig08_clustering_im.pdf){#fig:08-clustering-im}

The resulting fractal dimension and lacunarity estimates on these images show a very similar trend as the one observed on the size distributions image series (Figure \@ref(fig:08-clustering)). However, in this case *D* continues to drop from the first until the last iteration, albeit with some seemingly random fluctuations. Furthermore, after the first five iterations (which are in reality quite close to the entirely regular grid, see Figure \@ref(fig:08-clustering-im)), both lacunarity measures given here start to increase and do so regularly until the end of the series. Though again the ranges in both dimension and lacunarity are rather moderate here compared to those seen for density and image size above, the trend seen here is clear enough to conclude that hierarchical clustering is reflected in both these measures, in good accordance with the theory.

(ref:08-clustering) Fractal dimension and lacunarity measures on the same images with varying degrees of spatial clustering, and fixed image size, density, element count and size distributions. Number labels represent iteration

```{r 08-clustering, fig.cap="(ref:08-clustering)"}
load("Results/fig08_clustering.RData")
fig08_clustering
```

As a last test series of images to facilitate interpretation of fractal dimension and lacunarity estimates of settlement plans, 20 images were generated from the same point of departure as before -- i.e. image size of 540\*540 pixels, 27\*27 houses each of 10\*10 pixel size, giving 0.25 image density -- but where an increasing amount of spatial noise was added for each iteration. Again, this could be done in a number of ways. In this case, each house was allowed to do an independent random walk with a step length of 2.4 pixel equivalents in one of 12 circular directions (this caused some greyscaling in the resulting images, but the applied box-counting and gliding-box functions round such values to 0 and 1). Each random-walk step represented one iteration in the series [see @bruvollforthcoming for a similar approach]. An advantage of using square synthetic images for this test rather than simulations of actual settlement plans, is that the effect from such spatial noise can be more easily isolated from density. When elements walk in random directions, some will inevitably walk out from the initial pattern, thus decreasing image density no matter if the image is extended to include them or not. To solve this issue and making sure that density remained as constant as possible given how it was shown above to influence the resulting estimates, the image size was here kept constant and houses that moved beyond the boundaries were moved across the image to the opposite side. Some decrease in image density was however difficult to avoid given the frequent overlaps between houses that walked very close to each other, and the lowest density in this series extended to 0.232, which is still fairly close to the goal of 0.25. The resulting more or less noisy images in this series thus illustrate the range of possible settlement layouts from one where every house is strictly allotted to a predefined place following a simple geometric grid, to one where houses are constructed completely without any regard to the placement of surrounding houses (Figure \@ref(fig:08-noise-im)). Neither of these extremes are of course very likely for any real archaeological setting, but it seems obvious that the former case will be more characteristic of societies with strong overarching institutions that regulate everyday life while the latter case is more representative of very loose social ties between independent households and an absence of any overarching decision-making authority. #Ref?

![Different degrees of random spatial noise](Results/fig08_noise_im.pdf){#fig:08-noise-im alt="Different degrees of random spatial noise"}

CONTINUE FROM HERE!

(ref:08-noise) Different degrees of random spatial noise

```{r 08-noise, fig.cap="(ref:08-noise)"}
load("Results/fig08_noise.RData")
fig08_noise
```

Then see illustration on Figure \@ref(fig:08-noise).

That's it for the tests. Summarise below.

## Summary of procedure and tests

Just to sum up the different tests:

(ref:08-all) Results from all test series

```{r 08-all, fig.cap="(ref:08-all)"}
load("Results/fig08_all.RData")
fig08_all
```

Though the value ranges of the different tested factors are difficult to compare,... etc.

-   Procedure for archaeological samples, same as in article

-   Procedure for synthetic sample

END Chapter
